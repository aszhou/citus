-- CTE cannot be outside of FROM/WHERE clause
WITH cte AS (
	SELECT user_id FROM users_table WHERE value_2 IN (1, 2)
)
SELECT (SELECT * FROM cte);
WARNING:  more than one row returned by a subquery used as an expression
CONTEXT:  while executing command on localhost:57638
ERROR:  could not receive query results
WITH cte_basic AS (
	SELECT * FROM users_table
)
SELECT (SELECT user_id FROM cte_basic), user_id FROM users_table;
ERROR:  could not run distributed query with subquery outside the FROM and WHERE clauses
HINT:  Consider using an equality filter on the distributed table's partition column.
WITH cte_1 AS (
	WITH cte_1_1 AS (
		SELECT * FROM users_table
	),
	cte_1_2 AS (
		SELECT cte_1_1
	)
	SELECT user_id FROM cte_1_2
)
SELECT * FROM users_table WHERE user_id IN (SELECT * FROM cte_1);
ERROR:  column "cte_1_1" does not exist
LINE 6:   SELECT cte_1_1
                 ^
-- CTE in FROM/WHERE is usable
WITH cte_1 AS (
	WITH cte_1_1 AS (
		SELECT * FROM users_table WHERE value_2 IN (1, 2, 3)
	)
	SELECT user_id, value_2 FROM users_table WHERE user_id IN (
		SELECT user_id FROM cte_1_1
	)
)
SELECT * FROM cte_1 WHERE value_2 NOT IN (SELECT value_2 FROM cte_1);
 user_id | value_2 
---------+---------
(0 rows)

WITH cte_1 AS (
	WITH cte_1_1 AS (
		SELECT * FROM users_table WHERE value_2 IN (1, 2, 3)
	)
	SELECT user_id, value_2 FROM users_table WHERE user_id IN (
		SELECT user_id FROM cte_1_1
	)
)
SELECT * FROM cte_1 WHERE value_2 IN (
		SELECT 
			value_2 
		FROM 
			cte_1 
		WHERE 
			user_id IN (2, 3, 4) 
		ORDER BY 
			1 
		LIMIT 
			10
	)
ORDER BY 
	1, 2 
LIMIT 
	10;
 user_id | value_2 
---------+---------
       1 |       0
       2 |       0
       2 |       1
       2 |       1
       2 |       1
       3 |       1
       3 |       1
       4 |       0
       4 |       0
       4 |       0
(10 rows)

-- CTE in SELECT level should not be allowed
SELECT user_id = (
	WITH users_done_event_3 AS (
		SELECT users_table.user_id FROM users_table, events_table WHERE users_table.user_id=events_table.user_id AND event_type=3
	)
	SELECT user_id FROM users_done_event_3 WHERE user_id < 4 ORDER BY user_id LIMIT 1
)
FROM users_table 
ORDER BY 1
LIMIT 10;
 ?column? 
----------
 f
 f
 f
 f
 f
 f
 f
 f
 f
 f
(10 rows)

-- the same CTEs in FROM and WHERE
SELECT * FROM 
(
	WITH cte AS (
		SELECT user_id, value_2 FROM users_table
	)
	SELECT * FROM cte WHERE value_2 IN (SELECT user_id FROM cte)
) ctes
ORDER BY 
	1, 2
LIMIT 10;
 user_id | value_2 
---------+---------
       1 |       2
       1 |       3
       1 |       3
       1 |       4
       1 |       4
       1 |       4
       2 |       1
       2 |       1
       2 |       1
       2 |       2
(10 rows)

-- two different CTEs in FROM and WHERE
SELECT * FROM 
(
	WITH cte_from AS (
		SELECT user_id, value_2 FROM users_table
	),
	cte_where AS (
		SELECT value_2 FROM events_table
	)
	SELECT * FROM cte_from WHERE value_2 IN (SELECT * FROM cte_where)
) binded_ctes
ORDER BY 
	1, 2
LIMIT 10;
 user_id | value_2 
---------+---------
       1 |       0
       1 |       2
       1 |       3
       1 |       3
       1 |       4
       1 |       4
       1 |       4
       2 |       0
       2 |       1
       2 |       1
(10 rows)

SELECT * FROM 
(
	WITH cte_from AS (
		SELECT user_id, value_2 FROM users_table
	),
	cte_where AS (
		SELECT value_2 FROM events_table-- WHERE user_id in (SELECT user_id FROM cte_from)
	)
	SELECT * FROM cte_from WHERE value_2 IN (SELECT * FROM cte_where)
) binded_ctes
WHERE binded_ctes.user_id IN (
	WITH another_cte AS (
		SELECT user_id FROM events_table WHERE value_2 IN (1, 2, 3)
	)
	SELECT * FROM another_cte
)
ORDER BY
	1, 2
LIMIT
	10;
 user_id | value_2 
---------+---------
       1 |       0
       1 |       2
       1 |       3
       1 |       3
       1 |       4
       1 |       4
       1 |       4
       2 |       0
       2 |       1
       2 |       1
(10 rows)

-- CTEs in FROM should work
WITH cte AS (
	SELECT DISTINCT user_id, value_2 from users_table WHERE user_id IN (1, 2) ORDER BY 2 LIMIT 5 OFFSET 5
)
SELECT * FROM cte;
 user_id | value_2 
---------+---------
       2 |       3
       1 |       3
       2 |       4
       1 |       4
       2 |       5
(5 rows)

-- create and use CTE in FROM should work
SELECT * FROM (WITH cte AS (
		SELECT user_id, value_2 from users_table WHERE user_id IN (1, 2) ORDER BY 2 LIMIT 5
	)
SELECT * FROM cte) a;
 user_id | value_2 
---------+---------
       1 |       0
       2 |       0
       2 |       1
       2 |       1
       2 |       1
(5 rows)

--CTEs in FROM in a subquery should work
SELECT * FROM (WITH cte AS (
		SELECT user_id, value_2 from users_table WHERE user_id IN (1, 2) ORDER BY 2 LIMIT 5
	)
SELECT * FROM cte) b;
 user_id | value_2 
---------+---------
       1 |       0
       2 |       0
       2 |       1
       2 |       1
       2 |       1
(5 rows)

--CTEs in FROM in a subquery should work even when we create it there
SELECT * FROM (
	SELECT * FROM (WITH cte AS (
		SELECT user_id, value_2 from users_table WHERE user_id IN (1, 2) ORDER BY 2 LIMIT 5
		)
		SELECT * FROM cte
	) a) b;
 user_id | value_2 
---------+---------
       1 |       0
       2 |       0
       2 |       1
       2 |       1
       2 |       1
(5 rows)

-- CTEs in FROM and as a subquery in FROM should work
WITH users_events AS (
	WITH users_done_2_3 AS (
		SELECT users_table.user_id, users_table.value_2 FROM users_table, events_table WHERE users_table.user_id = events_table.user_id AND event_type IN (2, 3)
	)
	SELECT users_done_2_3.user_id, users_done_2_3.value_2 as value_2_3 FROM users_done_2_3
)
SELECT * FROM (SELECT * FROM users_events WHERE value_2_3 IN (2, 5)) a ORDER BY 1, 2 LIMIT 10;
 user_id | value_2_3 
---------+-----------
       1 |         2
       1 |         2
       1 |         2
       1 |         2
       1 |         2
       2 |         2
       2 |         2
       2 |         2
       2 |         2
       2 |         2
(10 rows)

-- SELECT * FROM (SELECT * FROM cte UNION SELECT * FROM distributed_table) a; should error out
WITH cte AS (
	SELECT * FROM users_table
)
SELECT * FROM (
	SELECT * FROM cte UNION (SELECT * FROM events_table)
	) a
ORDER BY 
	1,2,3,4,5,6
LIMIT 
	10;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Wed Nov 22 18:49:42.327403 2017 |       3 |       2 |       1 |        
       1 | Wed Nov 22 19:03:01.772353 2017 |       4 |       1 |       2 |        
       1 | Wed Nov 22 19:07:03.846437 2017 |       1 |       2 |       5 |        
       1 | Wed Nov 22 20:56:21.122638 2017 |       2 |       4 |       4 |        
       1 | Wed Nov 22 21:06:57.457147 2017 |       4 |       3 |       2 |        
       1 | Wed Nov 22 21:47:04.188168 2017 |       4 |       2 |       0 |        
       1 | Wed Nov 22 22:51:43.132261 2017 |       4 |       0 |       3 |        
       1 | Wed Nov 22 23:22:09.957743 2017 |       1 |       1 |       1 |        
       1 | Thu Nov 23 00:42:37.237615 2017 |       2 |       4 |       3 |        
       1 | Thu Nov 23 02:59:23.620864 2017 |       4 |       5 |       4 |        
(10 rows)

SELECT * FROM (
	SELECT * FROM (WITH cte AS (
			SELECT * FROM users_table
		)
		SELECT * FROM cte
	)b UNION (SELECT * FROM events_table)) a
ORDER BY 
1,2,3,4,5,6
LIMIT 
10;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Wed Nov 22 18:49:42.327403 2017 |       3 |       2 |       1 |        
       1 | Wed Nov 22 19:03:01.772353 2017 |       4 |       1 |       2 |        
       1 | Wed Nov 22 19:07:03.846437 2017 |       1 |       2 |       5 |        
       1 | Wed Nov 22 20:56:21.122638 2017 |       2 |       4 |       4 |        
       1 | Wed Nov 22 21:06:57.457147 2017 |       4 |       3 |       2 |        
       1 | Wed Nov 22 21:47:04.188168 2017 |       4 |       2 |       0 |        
       1 | Wed Nov 22 22:51:43.132261 2017 |       4 |       0 |       3 |        
       1 | Wed Nov 22 23:22:09.957743 2017 |       1 |       1 |       1 |        
       1 | Thu Nov 23 00:42:37.237615 2017 |       2 |       4 |       3 |        
       1 | Thu Nov 23 02:59:23.620864 2017 |       4 |       5 |       4 |        
(10 rows)

-- SELECT * FROM (SELECT * FROM cte UNION SELECT * FROM cte) a; should work
WITH cte AS (
	SELECT * FROM users_table WHERE user_id IN (1, 2)
)
SELECT * FROM (SELECT * FROM cte UNION (SELECT * FROM cte)) a
ORDER BY 
	1,2,3,4,5,6
LIMIT 
	10;
 user_id |              time               | value_1 | value_2 | value_3 | value_4 
---------+---------------------------------+---------+---------+---------+---------
       1 | Wed Nov 22 22:51:43.132261 2017 |       4 |       0 |       3 |        
       1 | Thu Nov 23 03:32:50.803031 2017 |       3 |       2 |       1 |        
       1 | Thu Nov 23 09:26:42.145043 2017 |       1 |       3 |       3 |        
       1 | Thu Nov 23 11:11:24.40789 2017  |       3 |       4 |       0 |        
       1 | Thu Nov 23 11:44:57.515981 2017 |       4 |       3 |       4 |        
       1 | Thu Nov 23 17:23:03.441394 2017 |       5 |       4 |       3 |        
       1 | Thu Nov 23 17:30:34.635085 2017 |       3 |       4 |       4 |        
       2 | Wed Nov 22 18:19:49.944985 2017 |       3 |       5 |       1 |        
       2 | Thu Nov 23 00:19:14.138058 2017 |       3 |       4 |       0 |        
       2 | Thu Nov 23 01:04:26.198826 2017 |       4 |       3 |       4 |        
(10 rows)

WITH cte AS (
	SELECT user_id, min(value_2) as val_2 FROM users_table WHERE user_id IN (1, 2, 3) GROUP BY user_id ORDER BY 2 DESC, 1 LIMIT 3 OFFSET 2
), 
cte_2 AS (
	SELECT user_id, max(value_2) as val_2 FROM users_table WHERE user_id IN (3, 4, 5) GROUP BY user_id
)
SELECT DISTINCT ON (user_id) user_id, sum(val_2) OVER () FROM (SELECT * FROM cte UNION (SELECT * FROM cte_2)) a
ORDER BY 
	1,2
LIMIT 
	10;
 user_id | sum 
---------+-----
       2 |  15
       3 |  15
       4 |  15
       5 |  15
(4 rows)

-- CTEs should work with VIEWs as well
CREATE VIEW basic_view AS 
SELECT * FROM users_table;
CREATE VIEW cte_view AS
WITH cte AS (
	SELECT * FROM users_table
)
SELECT user_id, max(value_1) as value_1 FROM cte GROUP BY 1;
WITH cte_user AS (
	SELECT basic_view.user_id,events_table.value_2 FROM basic_view join events_table on (basic_view.user_id = events_table.user_id)
)
SELECT user_id, sum(value_2) FROM cte_user GROUP BY 1 ORDER BY 1, 2;
 user_id | sum  
---------+------
       1 |  294
       2 | 1026
       3 |  782
       4 |  943
       5 |  806
       6 |  220
(6 rows)

SELECT * FROM cte_view;
 user_id | value_1 
---------+---------
       5 |       5
       2 |       4
       6 |       5
       1 |       5
       4 |       5
       3 |       5
(6 rows)

WITH cte_user_with_view AS 
(
	SELECT * FROM cte_view WHERE user_id < 3
)
SELECT user_id, value_1 FROM cte_user_with_view ORDER BY 1, 2 LIMIT 10 OFFSET 3;
 user_id | value_1 
---------+---------
(0 rows)

DROP VIEW basic_view;
DROP VIEW cte_view;
